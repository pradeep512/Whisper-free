#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
VENV_PY=""

# Allow explicit override
if [ -n "${WHISPER_PYTHON:-}" ] && [ -x "${WHISPER_PYTHON:-}" ]; then
  VENV_PY="$WHISPER_PYTHON"
else
  # Prefer venv in repo root, then archived venv if repo was cleaned
  if [ -x "$REPO_ROOT/venv/bin/python" ]; then
    VENV_PY="$REPO_ROOT/venv/bin/python"
  elif [ -x "$REPO_ROOT/archive/venv/bin/python" ]; then
    VENV_PY="$REPO_ROOT/archive/venv/bin/python"
  fi
fi

if [ -z "$VENV_PY" ]; then
  echo "Virtualenv not found." >&2
  echo "Create it with: python -m venv venv && source venv/bin/activate && pip install -r requirements.txt" >&2
  echo "Or set WHISPER_PYTHON to a Python executable with the dependencies installed." >&2
  exit 1
fi

# Optional: force XWayland so overlay positioning works on GNOME Wayland
# Usage: whisper --xwayland (or set WHISPER_FORCE_XWAYLAND=1)
# Default: if running on Wayland, force XWayland unless explicitly disabled.
FORCE_XWAYLAND=0
ARGS=()
for arg in "$@"; do
  if [ "$arg" = "--xwayland" ]; then
    FORCE_XWAYLAND=1
  elif [ "$arg" = "--wayland" ]; then
    FORCE_XWAYLAND=0
  else
    ARGS+=("$arg")
  fi
done
set -- "${ARGS[@]}"

if [ "${WHISPER_FORCE_XWAYLAND:-}" = "1" ]; then
  FORCE_XWAYLAND=1
fi
if [ "${WHISPER_FORCE_XWAYLAND:-}" = "0" ]; then
  FORCE_XWAYLAND=0
fi

if [ "${XDG_SESSION_TYPE:-}" = "wayland" ] && [ "$FORCE_XWAYLAND" = "0" ]; then
  # Default to XWayland on GNOME Wayland for reliable overlay positioning
  FORCE_XWAYLAND=1
fi

if [ "${XDG_SESSION_TYPE:-}" = "wayland" ] && [ "$FORCE_XWAYLAND" = "1" ]; then
  export QT_QPA_PLATFORM=xcb
fi

# IPC toggle mode: send command to running instance
if [ "${1:-}" = "--toggle" ]; then
  PYTHONPATH="$REPO_ROOT" exec "$VENV_PY" -c "
import sys
from PySide6.QtWidgets import QApplication
from app.core.ipc_server import send_ipc_command
app = QApplication(sys.argv)
if send_ipc_command('toggle'):
    sys.exit(0)
else:
    print('Whisper-Free is not running.', file=sys.stderr)
    sys.exit(1)
"
  exit $?
fi

PYTHONPATH="$REPO_ROOT" exec "$VENV_PY" -m app.main "$@"
